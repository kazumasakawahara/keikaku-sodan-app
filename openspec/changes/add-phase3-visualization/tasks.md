# Implementation Tasks for Phase 3

## 1. ネットワーク図機能の実装

### 1.1 バックエンド実装
- [ ] 1.1.1 ネットワークデータAPIエンドポイントの作成 (`app/api/network.py`)
  - GET /api/users/{user_id}/network
  - 認証チェック
  - エラーハンドリング
- [ ] 1.1.2 ネットワークサービスの実装 (`app/services/network_service.py`)
  - ノードデータの生成ロジック
  - エッジデータの生成ロジック
  - 色・重み計算ロジック
- [ ] 1.1.3 ネットワークAPIのテスト作成 (`tests/test_network.py`)
  - 正常系テスト（関係機関あり/なし）
  - 認証エラーテスト
  - 存在しない利用者のテスト

### 1.2 フロントエンド実装
- [ ] 1.2.1 D3.jsライブラリの導入
  - CDNリンクをbase.htmlに追加
  - バージョン: D3.js v7
- [ ] 1.2.2 ネットワーク図描画スクリプトの作成 (`app/static/js/network.js`)
  - Force-Directed Graphの実装
  - ノード・エッジの描画
  - ドラッグ操作の実装
  - ズーム操作の実装
  - ツールチップの実装
- [ ] 1.2.3 ネットワーク図スタイルの作成 (`app/static/css/network.css`)
  - ノードのスタイル
  - エッジのスタイル
  - ツールチップのスタイル
  - レスポンシブ対応
- [ ] 1.2.4 利用者詳細画面へのネットワーク図タブ追加 (`app/templates/users/detail.html`)
  - 「ネットワーク図」タブの追加
  - SVGキャンバスの配置
  - エクスポートボタンの配置
- [ ] 1.2.5 エクスポート機能の実装 (`app/static/js/network.js`内)
  - PNG保存機能
  - SVG保存機能
  - ファイル名生成ロジック

### 1.3 統合・テスト
- [ ] 1.3.1 PCブラウザでの動作確認
  - Chrome、Firefox、Safari
  - ドラッグ、ズーム、クリック操作
- [ ] 1.3.2 タブレットでの動作確認
  - iPad Safari
  - タッチ操作、ピンチジェスチャー
- [ ] 1.3.3 パフォーマンステスト
  - 関係機関10件での描画速度計測
  - 関係機関0件での表示確認
- [ ] 1.3.4 エクスポート機能のテスト
  - PNG保存の確認
  - SVG保存の確認

## 2. ダッシュボード強化の実装

### 2.1 バックエンド実装
- [ ] 2.1.1 ダッシュボード統計APIエンドポイントの作成 (`app/api/dashboard.py`)
  - GET /api/dashboard/statistics
  - GET /api/dashboard/alerts
  - 認証チェック
  - キャッシュ実装（15分）
- [ ] 2.1.2 ダッシュボードサービスの実装 (`app/services/dashboard_service.py`)
  - 利用者数推移の集計ロジック
  - 相談記録種別割合の集計ロジック
  - 計画承認状況の集計ロジック
  - モニタリング実施状況の集計ロジック
  - アラートデータの生成ロジック（計画更新期限、モニタリング期限、手帳更新期限）
- [ ] 2.1.3 ダッシュボードAPIのテスト作成 (`tests/test_dashboard.py`)
  - 統計データ取得テスト
  - アラートデータ取得テスト
  - キャッシュ動作テスト

### 2.2 フロントエンド実装
- [ ] 2.2.1 Chart.jsライブラリの導入
  - CDNリンクをbase.htmlに追加
  - バージョン: Chart.js v4
- [ ] 2.2.2 ダッシュボードグラフ描画スクリプトの作成 (`app/static/js/dashboard.js`)
  - 利用者数推移グラフ（折れ線グラフ）
  - 相談記録種別割合グラフ（円グラフ）
  - 計画承認状況グラフ（棒グラフ）
  - モニタリング実施状況グラフ（棒グラフ）
- [ ] 2.2.3 ダッシュボード画面の更新 (`app/templates/dashboard.html`)
  - 統計グラフセクションの追加
  - アラートセクションの追加
  - クイックアクションセクションの追加
  - レスポンシブレイアウトの実装
- [ ] 2.2.4 アラート表示の実装 (`app/templates/dashboard.html`内)
  - 計画更新期限が近い利用者テーブル
  - モニタリング期限が近い計画テーブル
  - 手帳更新期限が近い利用者テーブル
  - アラート0件時のメッセージ

### 2.3 統合・テスト
- [ ] 2.3.1 PCブラウザでの動作確認
  - すべてのグラフが正しく描画されるか
  - アラートが正しく表示されるか
- [ ] 2.3.2 タブレットでの動作確認
  - レスポンシブレイアウトが正しく機能するか
  - グラフがリサイズされるか
- [ ] 2.3.3 パフォーマンステスト
  - ページロード時間が3秒以内か
  - APIレスポンス時間が1秒以内か
- [ ] 2.3.4 キャッシュ動作確認
  - 15分以内の再表示でキャッシュが使われるか
  - データ更新時にキャッシュが無効化されるか

## 3. 高度な検索機能の実装

### 3.1 バックエンド実装
- [ ] 3.1.1 利用者検索APIの拡張 (`app/api/users.py`)
  - 複数条件パラメータの追加（name, name_kana, assigned_staff_id, disability_support_level_gte, notebook_type, guardian_type）
  - ページネーション（limit, offset）
  - ソート（order_by, order）
  - 総件数の返却（total_count）
- [ ] 3.1.2 計画検索APIの拡張 (`app/api/plans.py`)
  - 複数条件パラメータの追加（status, start_date_gte, end_date_lte, created_by_staff_id, user_name）
  - ページネーション対応
  - 利用者テーブルとのJOIN
- [ ] 3.1.3 モニタリング検索APIの拡張 (`app/api/monitorings.py`)
  - 複数条件パラメータの追加（monitoring_date_gte, monitoring_date_lte, staff_id, satisfaction, needs_plan_change）
  - ページネーション対応
- [ ] 3.1.4 検索APIのテスト作成 (`tests/test_advanced_search.py`)
  - 単一条件検索テスト
  - 複合条件検索テスト
  - ページネーションテスト
  - ソートテスト

### 3.2 フロントエンド実装
- [ ] 3.2.1 利用者一覧画面の検索フォーム拡張 (`app/templates/users/index.html`)
  - 詳細検索の表示/非表示ボタン
  - 担当スタッフドロップダウン
  - 障害支援区分ドロップダウン
  - 手帳種別ドロップダウン
  - 成年後見制度ドロップダウン
  - 条件クリアボタン
- [ ] 3.2.2 計画一覧画面の検索フォーム拡張 (`app/templates/plans/index.html`)
  - ステータスドロップダウン
  - 期間入力（開始日、終了日）
  - 担当スタッフドロップダウン
  - 利用者名入力
- [ ] 3.2.3 モニタリング一覧画面の検索フォーム拡張 (`app/templates/monitorings/index.html`)
  - 実施期間入力（開始日、終了日）
  - 実施者ドロップダウン
  - 満足度ドロップダウン
  - 計画変更必要性ドロップダウン
- [ ] 3.2.4 検索結果表示の実装
  - ページネーションコンポーネント
  - 検索結果件数表示
  - 検索条件サマリー表示
  - ローディングスピナー
  - 0件時のメッセージ
- [ ] 3.2.5 ソート機能の実装
  - テーブルヘッダークリックでソート
  - ソート方向の表示（↑↓アイコン）

### 3.3 統合・テスト
- [ ] 3.3.1 利用者検索のテスト
  - 各条件での検索確認
  - 複合条件での検索確認
  - ページネーション動作確認
  - ソート動作確認
- [ ] 3.3.2 計画検索のテスト
  - 各条件での検索確認
  - ページネーション動作確認
- [ ] 3.3.3 モニタリング検索のテスト
  - 各条件での検索確認
  - ページネーション動作確認
- [ ] 3.3.4 パフォーマンステスト
  - 単一条件検索の速度（目標: 1秒以内）
  - 複合条件検索の速度（目標: 2秒以内）
  - 100件以上の検索結果での動作確認

## 4. ドキュメント更新

- [ ] 4.1 README.mdの更新
  - Phase 3機能の説明追加
- [ ] 4.2 CLAUDE.mdの更新
  - Phase 3の完了マーク
  - 技術スタック（D3.js, Chart.js）の追加
- [ ] 4.3 HANDOVER.mdの更新
  - Phase 3実装内容の記録
- [ ] 4.4 ユーザーガイドの作成（新規）
  - ネットワーク図の使い方
  - ダッシュボードの見方
  - 高度な検索の使い方

## 5. 最終確認・リリース準備

- [ ] 5.1 統合テスト
  - すべての機能が連携して動作するか
  - Phase 1 & 2機能に影響がないか（回帰テスト）
- [ ] 5.2 パフォーマンステスト
  - ダッシュボード表示速度
  - ネットワーク図描画速度
  - 検索レスポンス速度
- [ ] 5.3 ブラウザ互換性確認
  - Chrome (最新版)
  - Firefox (最新版)
  - Safari (最新版)
  - iPad Safari
- [ ] 5.4 データベースバックアップ
  - リリース前のバックアップ実施
- [ ] 5.5 リリースノート作成
  - Phase 3で追加された機能の説明
  - 使い方のガイド
  - 既知の制限事項

## 実装順序の推奨

### Week 1-2: ネットワーク図機能
最優先機能。計画相談支援の核心である「ネットワーク構築」を可視化。

### Week 3-4: ダッシュボード強化
日常業務の効率化。期限管理の見落とし防止。

### Week 5-6: 高度な検索機能
データアクセスの効率化。情報検索の高速化。

### Week 7: 統合テスト・リリース準備
全体の動作確認、ドキュメント整備。

## 完了基準

- [ ] すべてのタスクが完了している
- [ ] すべてのテストがパスしている
- [ ] パフォーマンス目標を達成している（ダッシュボード3秒、ネットワーク図3秒、検索2秒）
- [ ] PCとタブレットで正しく動作している
- [ ] ドキュメントが最新の状態に更新されている
- [ ] リリースノートが作成されている
