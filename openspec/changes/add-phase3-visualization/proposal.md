# Proposal: Phase 3 - 可視化・高度機能の実装

## Why

Phase 1 & 2で利用者管理、相談記録、計画・モニタリング、PDF出力機能が完成しました。現在、以下のデータが蓄積されています：
- 利用者: 5名
- 関係機関: 10件
- 利用者-関係機関紐付け: 10件
- 相談記録: 7件
- 計画: 5件
- モニタリング: 6件

しかし、以下の課題が残っています：
- **支援ネットワークの見える化不足**: 利用者を取り巻く支援体制が一目で把握できない
- **日常業務の効率化不足**: 期限管理（計画更新、モニタリング実施）が手動で見落としのリスクがある
- **データ活用の限界**: 蓄積したデータから統計情報や傾向を把握できない
- **高度な検索ニーズ**: 複数条件での検索や絞り込みができず、情報アクセスに時間がかかる

Phase 3では、計画相談支援の核心である「ネットワーク構築の可視化」を実現し、日常業務の効率化とデータ活用を進めます。

## What Changes

Phase 3で実装する3つの中核機能:

### 1. ネットワーク図の可視化（最優先）
**目的**: 利用者を取り巻く支援ネットワークを視覚化し、支援会議や家族説明で活用

**機能**:
- 利用者を中心としたインタラクティブなネットワーク図
- 関係機関（通所先/医療機関/後見人等）を種別で色分け表示
- 関係性の強度・頻度を視覚的に表現
- ドラッグ&ドロップ、ズーム操作
- ノードクリックで詳細情報表示
- PNG/SVG形式でエクスポート（印刷・資料作成用）
- 既存の`user_organizations`テーブルを活用（新規テーブル不要）

**技術**: D3.js (Force-Directed Graph)
- 軽量でCDN経由で利用可能
- カスタマイズ性が高い
- レスポンシブ対応が容易

**ユーザー価値**:
- 支援会議での説明資料として活用
- 家族への支援体制説明がわかりやすくなる
- 支援ネットワークの漏れや偏りを視覚的に発見

### 2. ダッシュボード強化
**目的**: 事業所全体の状況を一目で把握し、期限管理の見落としを防止

**機能**:
- **統計グラフ（Chart.js使用）**:
  - 利用者数の推移（月次）
  - 相談記録の種別割合（来所/訪問/電話/その他）
  - 計画の承認状況（作成中/承認済み/実施中）
  - モニタリング実施状況（今月実施/来月予定）
- **アラート機能**:
  - 計画更新期限が近い利用者（3ヶ月以内）
  - モニタリング期限が近い計画（1ヶ月以内）
  - 手帳更新期限が近い利用者（3ヶ月以内）
- **クイックアクション**:
  - 新規相談記録作成
  - 今日の予定確認
  - 未承認計画の確認

**技術**: Chart.js（CDN経由）
- シンプルで学習コストが低い
- レスポンシブ対応
- Bootstrap 5との相性が良い

**ユーザー価値**:
- 期限管理の負担軽減
- 見落とし防止による法令遵守
- 業務の優先順位付けが明確に

### 3. 高度な検索・フィルタ機能（基本版）
**目的**: 膨大なデータから必要な情報を素早く抽出

**機能**:
- **複合検索**:
  - 利用者: 名前/カナ/住所/担当スタッフ/障害支援区分/手帳種別
  - 計画: ステータス/期間/担当スタッフ
  - モニタリング: 満足度/計画変更必要性/期間
- **AND/OR条件の組み合わせ**:
  - 例: 「担当スタッフ=田中」AND「障害支援区分>=4」
- **検索結果のソート**:
  - 名前順/最終相談日順/計画期限順

**技術**: FastAPI + SQLAlchemy（既存技術の拡張）
- 新規ライブラリ不要
- 既存のクエリビルダーを活用

**ユーザー価値**:
- 情報アクセスの高速化
- 特定条件の利用者抽出が容易

### Phase 4以降に延期する機能
以下は実装が複雑または外部依存が大きいため、Phase 4以降に延期:
- **保存された検索条件**: ユーザー設定管理が必要
- **エクスポート機能（CSV/Excel）**: 外部ライブラリ（openpyxl等）が必要
- **レポート機能（月次/年次）**: 複雑な集計ロジックとテンプレート設計が必要
- **カスタムレポート**: ユーザー定義の集計条件に対応する高度な実装が必要

## Impact

### Affected specs
新規作成される仕様:
- `network-visualization` - ネットワーク図の可視化
- `dashboard` - ダッシュボード強化（統計・アラート）
- `advanced-search` - 高度な検索・フィルタ

### Affected code
新規作成・変更されるコード:
- `app/api/network.py` - ネットワーク図データAPI（新規）
- `app/api/dashboard.py` - ダッシュボード統計API（新規）
- `app/api/users.py` - 高度な検索エンドポイント追加（変更）
- `app/api/plans.py` - 高度な検索エンドポイント追加（変更）
- `app/api/monitorings.py` - 高度な検索エンドポイント追加（変更）
- `app/services/network_service.py` - ネットワーク図データ生成ロジック（新規）
- `app/services/dashboard_service.py` - ダッシュボード統計生成ロジック（新規）
- `app/templates/dashboard.html` - ダッシュボード画面（変更）
- `app/templates/users/detail.html` - 利用者詳細にネットワーク図タブ追加（変更）
- `app/static/js/network.js` - D3.jsによるネットワーク図描画（新規）
- `app/static/js/dashboard.js` - Chart.jsによる統計グラフ描画（新規）
- `app/static/css/network.css` - ネットワーク図スタイル（新規）

### 利用者への影響
**プラス影響**:
- 支援ネットワークの可視化により、支援会議の質向上
- アラート機能により、期限管理ミスの削減
- 統計データにより、事業所運営の改善点が明確化
- 高度な検索により、必要な情報へのアクセス時間短縮

**マイナス影響（軽微）**:
- 初回表示時、ネットワーク図の描画に1-2秒かかる可能性（データ量による）
- ダッシュボードの統計計算により、サーバー負荷が若干増加（影響は軽微）

### 技術的影響
**ライブラリの追加**:
- D3.js（CDN経由）: ネットワーク図
- Chart.js（CDN経由）: 統計グラフ
- 既存のPythonライブラリのみを使用（新規パッケージ不要）

**データベーススキーマ変更**:
- なし（既存テーブルを活用）

**パフォーマンス考慮**:
- ネットワーク図: クライアントサイド描画のため、サーバー負荷は低い
- ダッシュボード統計: 集計クエリにインデックスを活用（既存インデックスで対応可能）
- 高度な検索: 複合クエリでもインデックスを活用し、レスポンス時間を維持

### セキュリティ考慮事項
- ネットワーク図データは認証済みユーザーのみアクセス可能
- 統計情報は集計データのみ（個人情報は含まない）
- エクスポート機能（Phase 4以降）では出力権限を制限

### 運用への影響
- バックアップファイルサイズの増加は軽微（主にJavaScriptファイルの追加）
- ブラウザ要件: モダンブラウザ必須（IE11非対応）
- タブレット対応: D3.jsはタッチ操作に対応、Chart.jsはレスポンシブ対応

### 期待される成果
**定量的成果**:
- 期限管理ミス: 現状（月1-2件）→ 目標（月0件）
- 情報検索時間: 現状（平均3分）→ 目標（平均30秒）
- 支援会議準備時間: 現状（30分）→ 目標（10分）

**定性的成果**:
- 支援ネットワークの可視化による支援の質向上
- データドリブンな意思決定の実現
- スタッフの業務満足度向上
