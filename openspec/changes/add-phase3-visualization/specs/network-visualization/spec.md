# Network Visualization Specification

## ADDED Requirements

### Requirement: ネットワーク図の表示
利用者詳細画面にネットワーク図タブを追加し、利用者を中心とした関係機関のネットワークを視覚化する機能を提供するMUST。

#### Scenario: 利用者詳細画面でネットワーク図タブを選択
- **WHEN** 利用者詳細画面で「ネットワーク図」タブをクリック
- **THEN** 利用者を中心に配置したネットワーク図が描画される
- **AND** 関係機関が種別（通所先/医療機関/後見人/その他）で色分けされて表示される
- **AND** 利用者と関係機関の間に線（エッジ）が表示される

#### Scenario: 関係機関が存在しない利用者
- **WHEN** 関係機関が登録されていない利用者のネットワーク図を表示
- **THEN** 利用者ノードのみが中央に表示される
- **AND** 「この利用者には関係機関が登録されていません」というメッセージが表示される

### Requirement: インタラクティブ操作
ネットワーク図上で、ユーザーがドラッグ、ズーム、クリック操作を行えるMUST。

#### Scenario: ノードのドラッグ操作
- **WHEN** ネットワーク図上のノード（利用者または関係機関）をドラッグ
- **THEN** ノードの位置が移動する
- **AND** 接続されたエッジも追従して再描画される
- **AND** 他のノードはForce Simulationにより自動的に再配置される

#### Scenario: ネットワーク図のズーム操作
- **WHEN** マウスホイールでスクロール操作またはピンチジェスチャー
- **THEN** ネットワーク図全体が拡大/縮小される
- **AND** 最小倍率0.5倍、最大倍率3倍の範囲内でズーム可能

#### Scenario: ノードのクリック操作
- **WHEN** 関係機関ノードをクリック
- **THEN** ノードがハイライト表示される
- **AND** ツールチップに関係機関の詳細情報（名称、種別、担当者、電話番号）が表示される

### Requirement: ノードの視覚表現
ノードとエッジの視覚表現により、関係性の種別と強度を表現するMUST。

#### Scenario: 関係機関種別による色分け
- **WHEN** ネットワーク図を表示
- **THEN** 利用者ノードは青色で表示される
- **AND** サービス事業所ノードは緑色で表示される
- **AND** 医療機関ノードは赤色で表示される
- **AND** 後見人ノードはオレンジ色で表示される
- **AND** その他関係機関ノードはグレー色で表示される

#### Scenario: 関係性の頻度による線の太さ
- **WHEN** user_organizationsテーブルのfrequency値が設定されている
- **THEN** 頻度「毎日」の関係は太い線（3px）で表示される
- **AND** 頻度「週1回」の関係は中太の線（2px）で表示される
- **AND** 頻度「月1回」の関係は細い線（1px）で表示される
- **AND** 頻度が未設定の場合は中太の線（2px）で表示される

### Requirement: エクスポート機能
ネットワーク図をPNG/SVG形式で保存できるMUST。

#### Scenario: PNG形式でエクスポート
- **WHEN** 「PNG保存」ボタンをクリック
- **THEN** 現在表示されているネットワーク図がPNG画像としてダウンロードされる
- **AND** ファイル名は`network-{利用者名}-{YYYYMMDD}.png`形式

#### Scenario: SVG形式でエクスポート
- **WHEN** 「SVG保存」ボタンをクリック
- **THEN** 現在表示されているネットワーク図がSVG画像としてダウンロードされる
- **AND** ファイル名は`network-{利用者名}-{YYYYMMDD}.svg`形式
- **AND** SVGファイルは編集可能な形式で保存される

### Requirement: ネットワークデータAPI
バックエンドAPIでネットワーク図用のデータを提供するMUST。

#### Scenario: ネットワークデータの取得
- **WHEN** GET /api/users/{user_id}/network を呼び出す
- **THEN** 以下のJSON形式でデータが返される:
```json
{
  "nodes": [
    {
      "id": "user-1",
      "label": "山田太郎",
      "type": "user",
      "color": "#4A90E2"
    },
    {
      "id": "org-1",
      "label": "〇〇事業所",
      "type": "service",
      "color": "#7ED321",
      "details": {
        "name": "〇〇事業所",
        "type": "サービス事業所",
        "contact_person": "田中花子",
        "phone": "093-123-4567"
      }
    }
  ],
  "edges": [
    {
      "source": "user-1",
      "target": "org-1",
      "relationship": "通所先",
      "frequency": "毎日",
      "weight": 3
    }
  ]
}
```
- **AND** 認証されていないリクエストは401エラーを返す

#### Scenario: 関係機関が存在しない利用者
- **WHEN** 関係機関が登録されていない利用者のネットワークデータを取得
- **THEN** nodesには利用者ノードのみが含まれる
- **AND** edgesは空配列[]が返される

### Requirement: レスポンシブ対応
ネットワーク図はPC・タブレット両方で適切に表示されるMUST。

#### Scenario: タブレットでの表示
- **WHEN** iPadまたはAndroidタブレットでネットワーク図を表示
- **THEN** 画面サイズに合わせてSVGキャンバスがリサイズされる
- **AND** タッチジェスチャーでドラッグ操作が可能
- **AND** ピンチジェスチャーでズーム操作が可能

### Requirement: パフォーマンス
ネットワーク図は3秒以内に初期描画が完了するMUST。

#### Scenario: 関係機関10件の利用者
- **WHEN** 関係機関10件が登録されている利用者のネットワーク図を表示
- **THEN** APIレスポンスは500ms以内に返される
- **AND** D3.jsによる描画は2秒以内に完了する
- **AND** Force Simulationは3秒以内に収束する

#### Scenario: 関係機関30件以上の利用者（将来対応）
- **WHEN** 関係機関30件以上が登録されている利用者のネットワーク図を表示
- **THEN** 警告メッセージ「関係機関が多いため、描画に時間がかかります」が表示される
- **AND** 描画は5秒以内に完了する

### Requirement: アクセシビリティ
ネットワーク図は色覚障害者にも配慮した表示を提供するMUST。

#### Scenario: 色覚障害対応
- **WHEN** ネットワーク図を表示
- **THEN** 各ノードタイプには色だけでなく、アイコンまたはラベルも表示される
- **AND** ツールチップで詳細情報を確認できる
- **AND** キーボード操作（Tabキー）でノードを選択できる
