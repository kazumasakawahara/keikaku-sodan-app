# Dashboard Enhancement Specification

## ADDED Requirements

### Requirement: 統計グラフの表示
ダッシュボードに事業所全体の統計情報をグラフで表示するMUST。

#### Scenario: 利用者数の推移グラフ
- **WHEN** ダッシュボードを表示
- **THEN** 過去12ヶ月の利用者数推移が折れ線グラフで表示される
- **AND** X軸は月（YYYY-MM形式）、Y軸は利用者数
- **AND** グラフにマウスオーバーすると、その月の利用者数が表示される

#### Scenario: 相談記録の種別割合グラフ
- **WHEN** ダッシュボードを表示
- **THEN** 今月の相談記録が種別（来所/訪問/電話/その他）ごとに円グラフで表示される
- **AND** 各セクターに割合（%）とラベルが表示される
- **AND** 相談記録が0件の場合は「データがありません」と表示される

#### Scenario: 計画の承認状況グラフ
- **WHEN** ダッシュボードを表示
- **THEN** 現在の計画が承認状況（作成中/承認済み/実施中）ごとに棒グラフで表示される
- **AND** X軸はステータス、Y軸は件数
- **AND** 各バーをクリックすると、該当する計画一覧画面へ遷移する

#### Scenario: モニタリング実施状況グラフ
- **WHEN** ダッシュボードを表示
- **THEN** 今月実施済みと来月予定のモニタリング件数が棒グラフで表示される
- **AND** X軸は「今月実施」「来月予定」、Y軸は件数
- **AND** 来月予定が5件以上の場合、バーが赤色で強調表示される

### Requirement: アラート機能
期限が近い項目をダッシュボードに警告表示するMUST。

#### Scenario: 計画更新期限が近い利用者のアラート
- **WHEN** ダッシュボードを表示
- **THEN** 計画終了日が3ヶ月以内の利用者が一覧表示される
- **AND** アラートは「計画更新期限が近い利用者（◯件）」というタイトルで表示される
- **AND** 各利用者行に「氏名」「計画終了日」「残り日数」が表示される
- **AND** 利用者名をクリックすると、利用者詳細画面へ遷移する

#### Scenario: モニタリング期限が近い計画のアラート
- **WHEN** ダッシュボードを表示
- **THEN** 次回モニタリング予定日が1ヶ月以内の計画が一覧表示される
- **AND** アラートは「モニタリング期限が近い計画（◯件）」というタイトルで表示される
- **AND** 各計画行に「利用者名」「次回モニタリング予定日」「残り日数」が表示される

#### Scenario: 手帳更新期限が近い利用者のアラート
- **WHEN** ダッシュボードを表示
- **THEN** 手帳の更新日が3ヶ月以内の利用者が一覧表示される
- **AND** アラートは「手帳更新期限が近い利用者（◯件）」というタイトルで表示される
- **AND** 各利用者行に「氏名」「手帳種別」「更新日」「残り日数」が表示される

#### Scenario: アラート対象がゼロの場合
- **WHEN** すべてのアラート対象が0件の場合
- **THEN** 「現在、期限が近い項目はありません」というメッセージが表示される
- **AND** グリーンの背景で「✓」アイコンが表示される

### Requirement: クイックアクション
ダッシュボードから頻繁に使う機能へ素早くアクセスできるMUST。

#### Scenario: 新規相談記録作成
- **WHEN** ダッシュボードの「新規相談記録」ボタンをクリック
- **THEN** 新規相談記録作成画面へ遷移する
- **AND** 利用者選択ドロップダウンには全利用者が表示される

#### Scenario: 今日の予定確認
- **WHEN** ダッシュボードの「今日の予定」ボタンをクリック
- **THEN** 今日のモニタリング予定と相談予定が一覧表示される
- **AND** 予定がない場合は「本日の予定はありません」と表示される

#### Scenario: 未承認計画の確認
- **WHEN** ダッシュボードの「未承認計画」ボタンをクリック
- **THEN** ステータスが「作成中」の計画一覧画面へ遷移する
- **AND** 未承認計画が0件の場合は「未承認の計画はありません」と表示される

### Requirement: ダッシュボード統計API
バックエンドAPIでダッシュボード用の統計データを提供するMUST。

#### Scenario: 統計データの取得
- **WHEN** GET /api/dashboard/statistics を呼び出す
- **THEN** 以下のJSON形式でデータが返される:
```json
{
  "user_count_trend": [
    {"month": "2025-01", "count": 3},
    {"month": "2025-02", "count": 4},
    {"month": "2025-03", "count": 5}
  ],
  "consultation_types": [
    {"type": "来所", "count": 10},
    {"type": "訪問", "count": 5},
    {"type": "電話", "count": 3}
  ],
  "plan_status": [
    {"status": "作成中", "count": 2},
    {"status": "承認済み", "count": 3},
    {"status": "実施中", "count": 5}
  ],
  "monitoring_status": {
    "completed_this_month": 4,
    "scheduled_next_month": 6
  }
}
```
- **AND** 認証されていないリクエストは401エラーを返す

#### Scenario: アラートデータの取得
- **WHEN** GET /api/dashboard/alerts を呼び出す
- **THEN** 以下のJSON形式でデータが返される:
```json
{
  "plan_expiring_soon": [
    {
      "user_id": 1,
      "user_name": "山田太郎",
      "plan_end_date": "2025-05-31",
      "days_remaining": 60
    }
  ],
  "monitoring_due_soon": [
    {
      "plan_id": 1,
      "user_name": "山田太郎",
      "next_monitoring_date": "2025-04-30",
      "days_remaining": 30
    }
  ],
  "notebook_renewal_soon": [
    {
      "user_id": 2,
      "user_name": "佐藤花子",
      "notebook_type": "療育手帳",
      "renewal_date": "2025-06-01",
      "days_remaining": 90
    }
  ]
}
```

### Requirement: レスポンシブ対応
ダッシュボードはPC・タブレット両方で適切に表示されるMUST。

#### Scenario: タブレットでの表示
- **WHEN** iPadまたはAndroidタブレットでダッシュボードを表示
- **THEN** グラフが画面幅に合わせてリサイズされる
- **AND** グラフは2カラムレイアウトから1カラムレイアウトに変更される
- **AND** アラートテーブルはスクロール可能になる

### Requirement: パフォーマンス
ダッシュボードは3秒以内にすべての統計情報が表示されるMUST。

#### Scenario: 初回ロード
- **WHEN** ダッシュボード画面にアクセス
- **THEN** 統計APIのレスポンスは1秒以内に返される
- **AND** Chart.jsによるグラフ描画は2秒以内に完了する
- **AND** ページ全体のロードは3秒以内に完了する

### Requirement: キャッシュ戦略
ダッシュボードの統計データは一定期間キャッシュされるMUST。

#### Scenario: 統計データのキャッシュ
- **WHEN** ダッシュボードを初回表示
- **THEN** 統計データがサーバーサイドで15分間キャッシュされる
- **AND** 15分以内の再表示ではキャッシュされたデータが返される
- **AND** 利用者・計画・モニタリングが更新された場合、キャッシュは無効化される

## MODIFIED Requirements

なし（既存機能の変更はなし）

## REMOVED Requirements

なし（削除される機能はなし）
