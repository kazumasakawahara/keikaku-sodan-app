# Advanced Search Specification

## ADDED Requirements

### Requirement: 利用者の複合検索
利用者一覧画面で複数条件を組み合わせた検索ができるMUST。

#### Scenario: 名前とカナでの検索
- **WHEN** 検索フォームで「名前」に「山田」、「カナ」に「ヤマダ」を入力して検索
- **THEN** 名前に「山田」を含み、かつカナに「ヤマダ」を含む利用者が一覧表示される
- **AND** 部分一致検索（LIKE '%山田%'）が実行される

#### Scenario: 担当スタッフと障害支援区分での絞り込み
- **WHEN** 検索フォームで「担当スタッフ」に「田中太郎」を選択し、「障害支援区分」に「4以上」を選択
- **THEN** 担当スタッフが田中太郎で、障害支援区分が4以上の利用者が一覧表示される
- **AND** 障害支援区分が未設定の利用者は除外される

#### Scenario: 手帳種別での絞り込み
- **WHEN** 検索フォームで「手帳種別」に「療育手帳」を選択
- **THEN** 療育手帳を持つ利用者が一覧表示される
- **AND** 複数の手帳を持つ利用者も含まれる

#### Scenario: 成年後見制度利用での絞り込み
- **WHEN** 検索フォームで「成年後見制度」に「利用中」を選択
- **THEN** guardian_typeが設定されている（NULL以外）利用者が一覧表示される

#### Scenario: 最終相談日での並び替え
- **WHEN** 検索結果で「最終相談日」カラムのヘッダーをクリック
- **THEN** 最終相談日が新しい順に利用者が並び替えられる
- **AND** 再度クリックすると、古い順に並び替えられる

#### Scenario: すべての条件をクリア
- **WHEN** 「条件をクリア」ボタンをクリック
- **THEN** すべての検索条件がリセットされる
- **AND** 全利用者が一覧表示される

### Requirement: 計画の複合検索
計画一覧画面で複数条件を組み合わせた検索ができるMUST。

#### Scenario: ステータスと期間での検索
- **WHEN** 検索フォームで「ステータス」に「実施中」を選択し、「期間」に「2025-01-01〜2025-12-31」を入力
- **THEN** ステータスが「実施中」で、計画期間が2025年の計画が一覧表示される
- **AND** 計画開始日または終了日が指定期間内の計画が含まれる

#### Scenario: 担当スタッフでの絞り込み
- **WHEN** 検索フォームで「担当スタッフ」に「田中太郎」を選択
- **THEN** 作成者が田中太郎の計画が一覧表示される

#### Scenario: 利用者名での検索
- **WHEN** 検索フォームで「利用者名」に「山田」を入力
- **THEN** 利用者名に「山田」を含む計画が一覧表示される
- **AND** 利用者テーブルとのJOINクエリが実行される

### Requirement: モニタリングの複合検索
モニタリング一覧画面で複数条件を組み合わせた検索ができるMUST。

#### Scenario: 満足度と計画変更必要性での検索
- **WHEN** 検索フォームで「満足度」に「高い」を選択し、「計画変更必要性」に「あり」を選択
- **THEN** 満足度が高く、計画変更が必要なモニタリングが一覧表示される

#### Scenario: 実施期間での検索
- **WHEN** 検索フォームで「実施期間」に「2025-03-01〜2025-03-31」を入力
- **THEN** 2025年3月に実施されたモニタリングが一覧表示される

#### Scenario: 実施者での絞り込み
- **WHEN** 検索フォームで「実施者」に「田中太郎」を選択
- **THEN** 実施者が田中太郎のモニタリングが一覧表示される

### Requirement: 検索API
バックエンドAPIで高度な検索機能を提供するMUST。

#### Scenario: 利用者検索API
- **WHEN** GET /api/users?name=山田&assigned_staff_id=1&disability_support_level_gte=4 を呼び出す
- **THEN** 以下の条件でフィルタリングされた利用者が返される:
  - 名前に「山田」を含む（部分一致）
  - 担当スタッフIDが1
  - 障害支援区分が4以上
- **AND** 論理削除されていない利用者のみが返される
- **AND** ページネーション（limit/offset）に対応する

#### Scenario: 計画検索API
- **WHEN** GET /api/plans?status=実施中&start_date_gte=2025-01-01&end_date_lte=2025-12-31 を呼び出す
- **THEN** 以下の条件でフィルタリングされた計画が返される:
  - ステータスが「実施中」
  - 開始日が2025-01-01以降
  - 終了日が2025-12-31以前
- **AND** 利用者名も含めて返される（JOIN結果）

#### Scenario: モニタリング検索API
- **WHEN** GET /api/monitorings?monitoring_date_gte=2025-03-01&monitoring_date_lte=2025-03-31&staff_id=1 を呼び出す
- **THEN** 以下の条件でフィルタリングされたモニタリングが返される:
  - 実施日が2025-03-01以降
  - 実施日が2025-03-31以前
  - 実施者IDが1

### Requirement: ページネーション
検索結果が多い場合、ページネーションで分割表示するMUST。

#### Scenario: 検索結果のページネーション
- **WHEN** 検索結果が50件以上の場合
- **THEN** 1ページあたり20件表示される
- **AND** ページ番号ボタン（1, 2, 3, ...）が表示される
- **AND** 「前へ」「次へ」ボタンが表示される

#### Scenario: ページネーションAPIパラメータ
- **WHEN** GET /api/users?limit=20&offset=40 を呼び出す
- **THEN** 41件目〜60件目の利用者が返される
- **AND** レスポンスに総件数（total_count）が含まれる

### Requirement: パフォーマンス
検索結果は2秒以内に表示されるMUST。

#### Scenario: 単一条件での検索
- **WHEN** 名前のみで検索（インデックスあり）
- **THEN** SQLクエリは100ms以内に実行される
- **AND** ページ全体のレンダリングは1秒以内に完了する

#### Scenario: 複合条件での検索
- **WHEN** 3つ以上の条件で検索
- **THEN** SQLクエリは500ms以内に実行される
- **AND** ページ全体のレンダリングは2秒以内に完了する

#### Scenario: 検索結果が100件以上の場合
- **WHEN** 検索結果が100件以上の場合
- **THEN** ページネーションにより最初の20件のみがレンダリングされる
- **AND** 初期表示は2秒以内に完了する

### Requirement: ユーザーフィードバック
検索実行中と結果表示時に適切なフィードバックを提供するMUST。

#### Scenario: 検索実行中の表示
- **WHEN** 検索ボタンをクリック
- **THEN** ローディングスピナーが表示される
- **AND** 「検索中...」というメッセージが表示される
- **AND** 検索ボタンが非活性化される

#### Scenario: 検索結果が0件の場合
- **WHEN** 検索結果が0件の場合
- **THEN** 「条件に一致する結果が見つかりませんでした」と表示される
- **AND** 「条件を変更して再度検索してください」というヒントが表示される

#### Scenario: 検索結果件数の表示
- **WHEN** 検索結果が表示される
- **THEN** 「検索結果: ◯件」というメッセージが表示される
- **AND** 検索条件のサマリーが表示される（例: 「条件: 名前=山田, 担当スタッフ=田中太郎」）

## MODIFIED Requirements

### Requirement: 利用者一覧画面の検索機能
既存の簡易検索から高度な複合検索へ拡張するMUST。

#### Scenario: 既存の名前検索との互換性
- **WHEN** 検索フォームで「名前」のみを入力して検索
- **THEN** 既存の動作と同じく名前で部分一致検索が実行される
- **AND** 他の条件が空の場合は無視される

#### Scenario: 高度な検索フォームの表示/非表示
- **WHEN** 「詳細検索」ボタンをクリック
- **THEN** 追加の検索条件フォーム（担当スタッフ、障害支援区分、手帳種別等）が表示される
- **AND** 再度クリックすると非表示になる

## REMOVED Requirements

なし（削除される機能はなし）
