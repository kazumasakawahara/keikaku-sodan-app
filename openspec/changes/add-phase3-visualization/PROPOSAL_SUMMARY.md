# Phase 3 実装提案書 サマリー

**作成日**: 2025年10月24日
**提案ID**: add-phase3-visualization
**ステータス**: 承認待ち

---

## 📋 エグゼクティブサマリー

Phase 1 & 2で基本機能が完成し、現在5名の利用者、10件の関係機関、7件の相談記録、5件の計画、6件のモニタリングが蓄積されています。

Phase 3では、**可視化・高度機能**を実装し、以下3つの中核機能を提供します：

1. **ネットワーク図の可視化** - 支援ネットワークの見える化
2. **ダッシュボード強化** - 統計情報とアラート機能
3. **高度な検索機能** - 複数条件での高速検索

**期待される成果**:
- 期限管理ミス: 月1-2件 → **0件**
- 情報検索時間: 平均3分 → **30秒**
- 支援会議準備時間: 30分 → **10分**

---

## 🎯 実装する3つの機能

### 1. ネットワーク図の可視化（最優先）

#### 目的
利用者を取り巻く支援ネットワークを視覚化し、支援会議や家族説明で活用

#### 主要機能
- **インタラクティブなネットワーク図**
  - 利用者を中心に関係機関を配置
  - 種別で色分け（通所先=緑、医療機関=赤、後見人=オレンジ）
  - 頻度で線の太さを変更（毎日=太線、月1回=細線）
  - ドラッグ&ドロップ、ズーム操作
  - ノードクリックで詳細表示
- **エクスポート機能**
  - PNG保存（印刷・資料用）
  - SVG保存（編集可能）
  - ファイル名: `network-{利用者名}-{YYYYMMDD}.png`
- **レスポンシブ対応**
  - PC・タブレット両対応
  - タッチジェスチャー対応（ピンチでズーム）

#### 技術
- **D3.js** (Force-Directed Graph)
  - CDN経由で利用（パッケージ管理不要）
  - 軽量で柔軟性が高い
- **既存データ活用**
  - `user_organizations`テーブルを使用
  - 新規テーブル不要

#### 画面イメージ
```
┌─────────────────────────────────────────┐
│ 利用者詳細: 山田太郎                      │
├─────────────────────────────────────────┤
│ [基本情報] [相談記録] [計画] [ネットワーク図] │
├─────────────────────────────────────────┤
│                                         │
│          ○ 〇〇病院 (医療機関)           │
│            ↗                            │
│         ● 山田太郎                      │
│            ↘                            │
│          ○ △△事業所 (通所先)          │
│                                         │
│ [PNG保存] [SVG保存]                     │
└─────────────────────────────────────────┘
```

#### API仕様
- **GET /api/users/{user_id}/network**
  - レスポンス: JSON (nodes, edges)
  - 認証必須

---

### 2. ダッシュボード強化

#### 目的
事業所全体の状況を一目で把握し、期限管理の見落としを防止

#### 主要機能

##### 統計グラフ（Chart.js使用）
1. **利用者数の推移** - 折れ線グラフ（過去12ヶ月）
2. **相談記録の種別割合** - 円グラフ（来所/訪問/電話/その他）
3. **計画の承認状況** - 棒グラフ（作成中/承認済み/実施中）
4. **モニタリング実施状況** - 棒グラフ（今月実施/来月予定）

##### アラート機能
1. **計画更新期限が近い利用者** - 終了日3ヶ月以内
2. **モニタリング期限が近い計画** - 予定日1ヶ月以内
3. **手帳更新期限が近い利用者** - 更新日3ヶ月以内

##### クイックアクション
- 新規相談記録作成
- 今日の予定確認
- 未承認計画の確認

#### 技術
- **Chart.js v4** (CDN経由)
- **サーバーサイドキャッシュ** (15分間)
  - 集計クエリの実行頻度を削減
  - データ更新時に自動無効化

#### 画面イメージ
```
┌─────────────────────────────────────────┐
│ ダッシュボード                           │
├─────────────────────────────────────────┤
│ [統計グラフ]                             │
│ ┌──────────┐ ┌──────────┐              │
│ │利用者推移│ │相談種別  │              │
│ │(折れ線)  │ │(円グラフ)│              │
│ └──────────┘ └──────────┘              │
│                                         │
│ [アラート]                               │
│ ⚠️ 計画更新期限が近い利用者（3件）       │
│  - 山田太郎 (残り60日)                  │
│  - 佐藤花子 (残り45日)                  │
│                                         │
│ [クイックアクション]                     │
│ [新規相談] [今日の予定] [未承認計画]     │
└─────────────────────────────────────────┘
```

#### API仕様
- **GET /api/dashboard/statistics** - 統計データ
- **GET /api/dashboard/alerts** - アラートデータ

---

### 3. 高度な検索・フィルタ機能

#### 目的
膨大なデータから必要な情報を素早く抽出

#### 主要機能

##### 利用者検索
- 複合条件: 名前/カナ/住所/担当スタッフ/障害支援区分/手帳種別/成年後見制度
- AND条件の組み合わせ
- ソート機能（名前順/最終相談日順）
- ページネーション（20件/ページ）

##### 計画検索
- 複合条件: ステータス/期間/担当スタッフ/利用者名
- ページネーション対応

##### モニタリング検索
- 複合条件: 実施期間/実施者/満足度/計画変更必要性
- ページネーション対応

#### 技術
- **FastAPI + SQLAlchemy** (既存技術の拡張)
  - 動的クエリビルダー
  - インデックス活用
- **サーバーサイドページネーション** (limit/offset)

#### 画面イメージ
```
┌─────────────────────────────────────────┐
│ 利用者一覧                               │
├─────────────────────────────────────────┤
│ [簡易検索] [詳細検索 ▼]                 │
│                                         │
│ 名前: [     ] 担当スタッフ: [全て ▼]    │
│ 障害支援区分: [全て ▼] 手帳: [全て ▼]   │
│                                         │
│ [検索] [条件クリア]                      │
│                                         │
│ 検索結果: 3件                            │
│ ┌───────────────────────────┐          │
│ │氏名    │担当   │最終相談日│          │
│ │山田太郎│田中   │2025-03-15│          │
│ │佐藤花子│鈴木   │2025-03-10│          │
│ └───────────────────────────┘          │
│ [1] 2 3 ... [次へ]                      │
└─────────────────────────────────────────┘
```

#### API仕様
- **GET /api/users?name=山田&staff_id=1&level_gte=4&limit=20&offset=0**
- **GET /api/plans?status=実施中&start_date_gte=2025-01-01**
- **GET /api/monitorings?monitoring_date_gte=2025-03-01**

---

## 🚫 Phase 3で実装しない機能（Phase 4以降に延期）

以下の機能は実装が複雑または外部依存が大きいため、Phase 4以降に延期します：

1. **保存された検索条件** - ユーザー設定管理テーブルが必要
2. **CSV/Excelエクスポート** - 外部ライブラリ（openpyxl）が必要
3. **レポート機能（月次/年次）** - 複雑な集計ロジックとテンプレート設計が必要
4. **カスタムレポート** - ユーザー定義の集計条件に対応する高度な実装が必要
5. **ネットワーク図のリアルタイム編集** - ドラッグで関係性を変更する機能

---

## 📊 技術的な意思決定

### ライブラリ選択

| 用途 | 選択 | 理由 |
|------|------|------|
| ネットワーク図 | **D3.js** | 柔軟性が高い、軽量、CDN利用可能 |
| 統計グラフ | **Chart.js** | シンプル、レスポンシブ、Bootstrap 5と相性良好 |
| パッケージ管理 | **CDN** | パッケージ管理不要、保守コスト低 |

### データベース設計
- **新規テーブル不要** - 既存の`user_organizations`を活用
- **キャッシュ戦略** - ダッシュボード統計は15分間サーバーサイドキャッシュ
- **ページネーション** - サーバーサイド方式（limit/offset）

### パフォーマンス目標
- ダッシュボード初期ロード: **< 3秒**
- ネットワーク図描画: **< 3秒**
- 検索レスポンス: **< 2秒**

---

## 📅 実装スケジュール（推奨）

### Week 1-2: ネットワーク図機能
- バックエンドAPI実装
- D3.js描画ロジック実装
- エクスポート機能実装
- テスト・動作確認

### Week 3-4: ダッシュボード強化
- バックエンドAPI実装
- Chart.jsグラフ描画実装
- アラート機能実装
- テスト・動作確認

### Week 5-6: 高度な検索機能
- バックエンドAPI拡張
- 検索フォームUI実装
- ページネーション実装
- テスト・動作確認

### Week 7: 統合テスト・リリース準備
- 全体動作確認
- ドキュメント更新
- リリースノート作成

**合計: 約7週間（1.5ヶ月）**

---

## 🎯 期待される成果

### 定量的成果
| 指標 | 現状 | 目標 |
|------|------|------|
| 期限管理ミス | 月1-2件 | **月0件** |
| 情報検索時間 | 平均3分 | **平均30秒** |
| 支援会議準備時間 | 平均30分 | **平均10分** |

### 定性的成果
- **支援ネットワークの可視化** - 支援会議・家族説明の質向上
- **データドリブンな意思決定** - 統計情報に基づく事業所運営
- **業務効率化** - アラート機能による期限管理の自動化
- **情報アクセス向上** - 高度な検索による情報検索の高速化

---

## ⚠️ リスクと対策

### リスク1: ネットワーク図のパフォーマンス低下
**状況**: 関係機関が30件以上の利用者では描画に時間がかかる

**対策**:
- 20件以上で警告メッセージ表示
- Force Simulationのiterations制限
- 必要に応じて静的レイアウトにフォールバック

### リスク2: SQLiteの同時書き込み制限
**状況**: 統計集計中に他ユーザーがデータ更新するとロックエラー

**対策**:
- キャッシュにより集計クエリの実行頻度を削減
- 読み取り専用クエリの優先度を下げる
- 将来的にPostgreSQLへ移行可能な設計

### リスク3: ブラウザ互換性問題
**状況**: IE11等の古いブラウザでは動作しない

**対策**:
- ログイン画面でブラウザチェック
- モダンブラウザの使用を推奨
- 警告メッセージの表示

---

## 📝 次のステップ

1. **提案書のレビュー** - この提案書を確認し、フィードバックを提供
2. **承認** - 提案内容に問題がなければ、実装を開始
3. **実装開始** - `tasks.md`に従って順次実装
4. **定期レビュー** - 週次で進捗確認とフィードバック

---

## 📚 関連ドキュメント

- **提案書**: `openspec/changes/add-phase3-visualization/proposal.md`
- **実装タスク**: `openspec/changes/add-phase3-visualization/tasks.md`
- **設計書**: `openspec/changes/add-phase3-visualization/design.md`
- **仕様書**:
  - `specs/network-visualization/spec.md`
  - `specs/dashboard/spec.md`
  - `specs/advanced-search/spec.md`

---

## ✅ 提案書の検証結果

```bash
$ openspec validate add-phase3-visualization --strict
Change 'add-phase3-visualization' is valid
```

提案書は正しく作成され、すべての要件を満たしています。

---

**最終更新**: 2025年10月24日
**作成者**: Claude (Requirements Analyst)
**レビュー待ち**: プロジェクトオーナー
