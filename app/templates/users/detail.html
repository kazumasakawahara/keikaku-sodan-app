{% extends "base.html" %}

{% block title %}利用者詳細 - 計画相談支援システム{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/users">利用者一覧</a></li>
                <li class="breadcrumb-item active">利用者詳細</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center">
            <h1 id="user-name">利用者詳細</h1>
            <div class="btn-group">
                <a href="/users/{{ user_id }}/network" class="btn btn-outline-primary">
                    <i class="bi bi-diagram-3"></i> ネットワーク図
                </a>
                <button class="btn btn-outline-success" onclick="downloadPDF()">
                    <i class="bi bi-file-pdf"></i> PDF出力
                </button>
                <button class="btn btn-outline-danger" onclick="deleteCurrentUser()">
                    <i class="bi bi-trash"></i> 削除
                </button>
            </div>
        </div>
    </div>
</div>

<div id="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">読み込み中...</span>
    </div>
</div>

<div id="user-detail" class="d-none">
    <!-- 基本情報 -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
            <h5 class="mb-0"><i class="bi bi-person"></i> 基本情報</h5>
            <button class="btn btn-sm btn-light" onclick="editUser()">
                <i class="bi bi-pencil"></i> 編集
            </button>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">氏名</th>
                            <td id="detail-name"></td>
                        </tr>
                        <tr>
                            <th>氏名（カナ）</th>
                            <td id="detail-name-kana"></td>
                        </tr>
                        <tr>
                            <th>生年月日</th>
                            <td id="detail-birth-date"></td>
                        </tr>
                        <tr>
                            <th>年齢</th>
                            <td id="detail-age"></td>
                        </tr>
                        <tr>
                            <th>性別</th>
                            <td id="detail-gender"></td>
                        </tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <table class="table table-sm">
                        <tr>
                            <th width="40%">郵便番号</th>
                            <td id="detail-postal-code"></td>
                        </tr>
                        <tr>
                            <th>住所</th>
                            <td id="detail-address"></td>
                        </tr>
                        <tr>
                            <th>電話番号</th>
                            <td id="detail-phone"></td>
                        </tr>
                        <tr>
                            <th>メールアドレス</th>
                            <td id="detail-email"></td>
                        </tr>
                        <tr>
                            <th>担当スタッフ</th>
                            <td id="detail-staff"></td>
                        </tr>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 詳細情報タブ -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-light">
            <ul class="nav nav-tabs card-header-tabs" id="userDetailTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="basic-info-tab" data-bs-toggle="tab" data-bs-target="#basic-info" type="button" role="tab">
                        <i class="bi bi-info-circle"></i> 詳細情報
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="consultations-tab" data-bs-toggle="tab" data-bs-target="#consultations" type="button" role="tab">
                        <i class="bi bi-chat-dots"></i> 相談記録 <span class="badge bg-success" id="consultations-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="plans-tab" data-bs-toggle="tab" data-bs-target="#plans" type="button" role="tab">
                        <i class="bi bi-file-earmark-text"></i> 計画 <span class="badge bg-warning text-dark" id="plans-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="monitorings-tab" data-bs-toggle="tab" data-bs-target="#monitorings" type="button" role="tab">
                        <i class="bi bi-clipboard-check"></i> モニタリング <span class="badge bg-info" id="monitorings-count">0</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="network-tab" data-bs-toggle="tab" data-bs-target="#network" type="button" role="tab">
                        <i class="bi bi-diagram-3"></i> ネットワーク図
                    </button>
                </li>
            </ul>
        </div>
        <div class="card-body">
            <div class="tab-content" id="userDetailTabsContent">
                <!-- 詳細情報タブ -->
                <div class="tab-pane fade show active" id="basic-info" role="tabpanel">
                    <!-- 手帳情報 -->
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="bi bi-card-list"></i> 手帳情報</h5>
                        <div id="notebooks-list">
                            <p class="text-muted">読み込み中...</p>
                        </div>
                    </div>

                    <!-- 障害支援区分 -->
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="bi bi-shield-check"></i> 障害支援区分</h5>
                        <table class="table table-sm table-bordered">
                            <tr>
                                <th width="30%" class="bg-light">障害支援区分</th>
                                <td id="detail-support-level"></td>
                            </tr>
                            <tr>
                                <th class="bg-light">認定日</th>
                                <td id="detail-certified-date"></td>
                            </tr>
                            <tr>
                                <th class="bg-light">有効期限</th>
                                <td id="detail-expiry-date"></td>
                            </tr>
                        </table>
                    </div>

                    <!-- 障害特性・興味の偏り -->
                    <div class="mb-4">
                        <h5 class="mb-3"><i class="bi bi-person-heart"></i> 障害特性・興味の偏り</h5>
                        <div class="mb-3">
                            <h6 class="fw-bold">障害特性</h6>
                            <div id="detail-disability-characteristics" class="border rounded p-3 bg-light" style="white-space: pre-wrap; min-height: 80px;">
                                <span class="text-muted">未登録</span>
                            </div>
                        </div>
                        <div>
                            <h6 class="fw-bold">興味の偏り</h6>
                            <div id="detail-interest-bias" class="border rounded p-3 bg-light" style="white-space: pre-wrap; min-height: 80px;">
                                <span class="text-muted">未登録</span>
                            </div>
                        </div>
                    </div>

                    <!-- 服薬情報 -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0"><i class="bi bi-capsule"></i> 服薬情報</h5>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-primary" onclick="addMedication()">
                                    <i class="bi bi-plus"></i> 新規登録
                                </button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="manageDoctors()">
                                    <i class="bi bi-person-badge"></i> 処方医管理
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="downloadMedicationsPDF()">
                                    <i class="bi bi-file-pdf"></i> PDF
                                </button>
                            </div>
                        </div>
                        <div id="medications-list">
                            <p class="text-muted">読み込み中...</p>
                        </div>
                    </div>
                </div>

                <!-- 相談記録タブ -->
                <div class="tab-pane fade" id="consultations" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-chat-dots"></i> 相談記録</h5>
                        <button class="btn btn-sm btn-success" onclick="addConsultation()">
                            <i class="bi bi-plus"></i> 新規記録
                        </button>
                    </div>
                    <div id="consultations-list">
                        <p class="text-muted">読み込み中...</p>
                    </div>
                </div>

                <!-- 計画タブ -->
                <div class="tab-pane fade" id="plans" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> サービス利用計画</h5>
                        <a href="/plans/create?user_id={{ user_id }}" class="btn btn-sm btn-warning">
                            <i class="bi bi-plus"></i> 新規作成
                        </a>
                    </div>
                    <div id="plans-list">
                        <p class="text-muted">読み込み中...</p>
                    </div>
                </div>

                <!-- モニタリングタブ -->
                <div class="tab-pane fade" id="monitorings" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> モニタリング記録</h5>
                        <a href="/monitorings/create?user_id={{ user_id }}" class="btn btn-sm btn-info">
                            <i class="bi bi-plus"></i> 新規作成
                        </a>
                    </div>
                    <div id="monitorings-list">
                        <p class="text-muted">読み込み中...</p>
                    </div>
                </div>

                <!-- ネットワーク図タブ -->
                <div class="tab-pane fade" id="network" role="tabpanel">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="mb-0"><i class="bi bi-diagram-3"></i> ネットワーク図（エコマップ）</h5>
                        <a href="/users/{{ user_id }}/network" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-arrows-fullscreen"></i> 全画面表示
                        </a>
                    </div>
                    <div id="network-preview" style="min-height: 400px;">
                        <p class="text-muted text-center py-5">読み込み中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="/static/js/medication-modal.js"></script>
<script>
    const userId = {{ user_id }};
    let userData = null;

    window.addEventListener('DOMContentLoaded', async () => {
        await checkAuth();
        await loadUserDetail();
        await loadNotebooks();
        await loadMedications();
        await loadConsultations();
        await loadPlans();
        await loadMonitorings();
        await loadNetworkPreview();
    });

    async function loadUserDetail() {
        try {
            const response = await fetch(`/api/users/${userId}`);
            if (response.ok) {
                userData = await response.json();
                displayUserDetail(userData);
            } else if (response.status === 404) {
                alert('利用者が見つかりませんでした');
                window.location.href = '/users';
            } else {
                alert('利用者情報の取得に失敗しました');
            }
        } catch (error) {
            console.error('エラー:', error);
            alert('サーバーとの通信に失敗しました');
        } finally {
            document.getElementById('loading').classList.add('d-none');
            document.getElementById('user-detail').classList.remove('d-none');
        }
    }

    function displayUserDetail(user) {
        document.getElementById('user-name').textContent = user.name;
        document.getElementById('detail-name').textContent = user.name;
        document.getElementById('detail-name-kana').textContent = user.name_kana || '-';
        document.getElementById('detail-birth-date').textContent = user.birth_date ? new Date(user.birth_date).toLocaleDateString('ja-JP') : '-';
        document.getElementById('detail-age').textContent = user.age !== null ? user.age + '歳' : '-';
        document.getElementById('detail-gender').textContent = user.gender || '-';
        document.getElementById('detail-postal-code').textContent = user.postal_code || '-';
        document.getElementById('detail-address').textContent = user.address || '-';
        document.getElementById('detail-phone').textContent = user.phone || '-';
        document.getElementById('detail-email').textContent = user.email || '-';
        document.getElementById('detail-staff').textContent = user.assigned_staff_id ? `スタッフID: ${user.assigned_staff_id}` : '-';
        document.getElementById('detail-support-level').textContent = user.disability_support_level ? `区分${user.disability_support_level}` : '-';
        document.getElementById('detail-certified-date').textContent = user.disability_support_certified_date ? new Date(user.disability_support_certified_date).toLocaleDateString('ja-JP') : '-';
        document.getElementById('detail-expiry-date').textContent = user.disability_support_expiry_date ? new Date(user.disability_support_expiry_date).toLocaleDateString('ja-JP') : '-';

        // 障害特性・興味の偏り
        const disabilityCharacteristicsEl = document.getElementById('detail-disability-characteristics');
        if (user.disability_characteristics) {
            disabilityCharacteristicsEl.textContent = user.disability_characteristics;
            disabilityCharacteristicsEl.classList.remove('text-muted');
        } else {
            disabilityCharacteristicsEl.innerHTML = '<span class="text-muted">未登録</span>';
        }

        const interestBiasEl = document.getElementById('detail-interest-bias');
        if (user.interest_bias) {
            interestBiasEl.textContent = user.interest_bias;
            interestBiasEl.classList.remove('text-muted');
        } else {
            interestBiasEl.innerHTML = '<span class="text-muted">未登録</span>';
        }
    }

    async function loadNotebooks() {
        try {
            const response = await fetch(`/api/users/${userId}/notebooks`);
            if (response.ok) {
                const notebooks = await response.json();
                const listDiv = document.getElementById('notebooks-list');

                if (notebooks.length === 0) {
                    listDiv.innerHTML = '<p class="text-muted">手帳情報が登録されていません</p>';
                    return;
                }

                listDiv.innerHTML = `
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>種別</th>
                                <th>等級・程度</th>
                                <th>交付日</th>
                                <th>更新日</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${notebooks.map(nb => `
                                <tr>
                                    <td>${nb.notebook_type}</td>
                                    <td>${nb.grade || '-'}</td>
                                    <td>${nb.issue_date ? new Date(nb.issue_date).toLocaleDateString('ja-JP') : '-'}</td>
                                    <td>${nb.renewal_date ? new Date(nb.renewal_date).toLocaleDateString('ja-JP') : '-'}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;
            }
        } catch (error) {
            console.error('エラー:', error);
        }
    }

    async function loadMedications() {
        try {
            const response = await fetch(`/api/medications?user_id=${userId}`);
            if (response.ok) {
                const medications = await response.json();
                const listDiv = document.getElementById('medications-list');

                if (medications.length === 0) {
                    listDiv.innerHTML = '<p class="text-muted">服薬情報が登録されていません</p>';
                    return;
                }

                // 現在服用中の薬と過去の薬を分ける
                const currentMeds = medications.filter(m => m.is_current);
                const pastMeds = medications.filter(m => !m.is_current);

                let html = '';

                if (currentMeds.length > 0) {
                    html += '<h6 class="mb-3"><i class="bi bi-capsule-pill"></i> 現在服用中</h6>';
                    html += '<div class="row g-3 mb-4">';
                    currentMeds.forEach(med => {
                        html += `
                            <div class="col-md-6">
                                <div class="card border-danger">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-0">${med.medication_name}</h6>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="editMedication(${med.id})">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteMedication(${med.id}, '${med.medication_name}')">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        ${med.generic_name ? `<p class="text-muted small mb-2">一般名: ${med.generic_name}</p>` : ''}
                                        <table class="table table-sm table-borderless mb-0">
                                            ${med.dosage ? `<tr><td class="text-muted" width="35%">用量:</td><td>${med.dosage}</td></tr>` : ''}
                                            ${med.frequency ? `<tr><td class="text-muted">服用回数:</td><td>${med.frequency}</td></tr>` : ''}
                                            ${med.timing ? `<tr><td class="text-muted">タイミング:</td><td>${med.timing}</td></tr>` : ''}
                                            ${med.start_date ? `<tr><td class="text-muted">開始日:</td><td>${new Date(med.start_date).toLocaleDateString('ja-JP')}</td></tr>` : ''}
                                            ${med.prescribing_doctor_name ? `<tr><td class="text-muted">処方医:</td><td>${med.prescribing_doctor_name}${med.prescribing_doctor_hospital ? ' (' + med.prescribing_doctor_hospital + ')' : ''}</td></tr>` : ''}
                                            ${med.purpose ? `<tr><td class="text-muted">処方目的:</td><td>${med.purpose}</td></tr>` : ''}
                                        </table>
                                        ${med.notes ? `<p class="text-muted small mb-0 mt-2"><i class="bi bi-sticky"></i> ${med.notes}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                if (pastMeds.length > 0) {
                    html += '<h6 class="mb-3 mt-3"><i class="bi bi-clock-history"></i> 服用履歴</h6>';
                    html += '<div class="accordion" id="pastMedicationsAccordion">';
                    pastMeds.forEach((med, index) => {
                        html += `
                            <div class="accordion-item">
                                <h2 class="accordion-header">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#pastMed${index}">
                                        ${med.medication_name} ${med.end_date ? '(〜' + new Date(med.end_date).toLocaleDateString('ja-JP') + ')' : ''}
                                    </button>
                                </h2>
                                <div id="pastMed${index}" class="accordion-collapse collapse" data-bs-parent="#pastMedicationsAccordion">
                                    <div class="accordion-body">
                                        <table class="table table-sm table-borderless mb-0">
                                            ${med.generic_name ? `<tr><td class="text-muted" width="35%">一般名:</td><td>${med.generic_name}</td></tr>` : ''}
                                            ${med.dosage ? `<tr><td class="text-muted">用量:</td><td>${med.dosage}</td></tr>` : ''}
                                            ${med.frequency ? `<tr><td class="text-muted">服用回数:</td><td>${med.frequency}</td></tr>` : ''}
                                            ${med.timing ? `<tr><td class="text-muted">タイミング:</td><td>${med.timing}</td></tr>` : ''}
                                            ${med.start_date ? `<tr><td class="text-muted">開始日:</td><td>${new Date(med.start_date).toLocaleDateString('ja-JP')}</td></tr>` : ''}
                                            ${med.end_date ? `<tr><td class="text-muted">終了日:</td><td>${new Date(med.end_date).toLocaleDateString('ja-JP')}</td></tr>` : ''}
                                            ${med.prescribing_doctor_name ? `<tr><td class="text-muted">処方医:</td><td>${med.prescribing_doctor_name}${med.prescribing_doctor_hospital ? ' (' + med.prescribing_doctor_hospital + ')' : ''}</td></tr>` : ''}
                                            ${med.purpose ? `<tr><td class="text-muted">処方目的:</td><td>${med.purpose}</td></tr>` : ''}
                                            ${med.notes ? `<tr><td class="text-muted">備考:</td><td>${med.notes}</td></tr>` : ''}
                                        </table>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                listDiv.innerHTML = html;
            }
        } catch (error) {
            console.error('エラー:', error);
            document.getElementById('medications-list').innerHTML = '<p class="text-danger">服薬情報の読み込みに失敗しました</p>';
        }
    }

    async function loadConsultations() {
        try {
            const response = await fetch(`/api/consultations?user_id=${userId}&limit=500`);
            if (response.ok) {
                const consultations = await response.json();
                const listDiv = document.getElementById('consultations-list');

                // 件数バッジを更新
                document.getElementById('consultations-count').textContent = consultations.length;

                if (consultations.length === 0) {
                    listDiv.innerHTML = '<p class="text-muted">相談記録がありません</p>';
                    return;
                }

                // 最新10件のみ表示
                const displayConsultations = consultations.slice(0, 10);

                listDiv.innerHTML = displayConsultations.map(c => `
                    <div class="card mb-2">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="mb-2">${new Date(c.consultation_date).toLocaleDateString('ja-JP')} - ${c.consultation_type}</h6>
                                <div class="text-end">
                                    <small class="text-muted d-block">スタッフID: ${c.staff_id}</small>
                                    <a href="/consultations/${c.id}" class="btn btn-sm btn-outline-primary mt-1">
                                        <i class="bi bi-eye"></i> 詳細
                                    </a>
                                </div>
                            </div>
                            <p class="mb-1"><strong>相談内容:</strong> ${c.content.length > 100 ? c.content.substring(0, 100) + '...' : c.content}</p>
                            ${c.response ? `<p class="mb-0 text-muted"><strong>対応:</strong> ${c.response.length > 100 ? c.response.substring(0, 100) + '...' : c.response}</p>` : ''}
                        </div>
                    </div>
                `).join('');

                // 件数が10件を超える場合は「もっと見る」メッセージを追加
                if (consultations.length > 10) {
                    listDiv.innerHTML += `
                        <div class="alert alert-info mt-3">
                            <i class="bi bi-info-circle"></i> 最新10件を表示しています。全${consultations.length}件の記録があります。
                        </div>
                    `;
                }
            }
        } catch (error) {
            console.error('エラー:', error);
            document.getElementById('consultations-list').innerHTML = '<p class="text-danger">相談記録の読み込みに失敗しました</p>';
        }
    }

    function editUser() {
        window.location.href = `/users/${userId}/edit`;
    }

    function addConsultation() {
        window.location.href = `/consultations/new?user_id=${userId}`;
    }

    async function loadPlans() {
        try {
            const response = await fetch(`/api/plans?user_id=${userId}&limit=500`, {
                credentials: 'include'
            });
            const plansList = document.getElementById('plans-list');

            if (response.ok) {
                const plans = await response.json();

                // 件数バッジを更新
                document.getElementById('plans-count').textContent = plans.length;

                if (plans.length === 0) {
                    plansList.innerHTML = '<p class="text-muted">サービス利用計画はまだ作成されていません</p>';
                } else {
                    plansList.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>計画期間</th>
                                        <th>担当者</th>
                                        <th>ステータス</th>
                                        <th>作成日</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${plans.map(plan => `
                                        <tr>
                                            <td>${new Date(plan.plan_start_date).toLocaleDateString('ja-JP')} 〜 ${new Date(plan.plan_end_date).toLocaleDateString('ja-JP')}</td>
                                            <td>スタッフID: ${plan.staff_id}</td>
                                            <td><span class="badge ${plan.is_approved ? 'bg-success' : 'bg-warning text-dark'}">${plan.is_approved ? '承認済' : '未承認'}</span></td>
                                            <td>${new Date(plan.created_at).toLocaleDateString('ja-JP')}</td>
                                            <td>
                                                <a href="/plans/${plan.id}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye"></i> 詳細
                                                </a>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;
                }
            } else {
                plansList.innerHTML = '<p class="text-danger">計画の取得に失敗しました</p>';
            }
        } catch (error) {
            console.error('エラー:', error);
            document.getElementById('plans-list').innerHTML = '<p class="text-danger">計画の取得中にエラーが発生しました</p>';
        }
    }

    async function loadMonitorings() {
        try {
            const response = await fetch(`/api/monitorings?user_id=${userId}&limit=500`, {
                credentials: 'include'
            });
            const monitoringsList = document.getElementById('monitorings-list');

            if (response.ok) {
                const monitorings = await response.json();

                // 件数バッジを更新
                document.getElementById('monitorings-count').textContent = monitorings.length;

                if (monitorings.length === 0) {
                    monitoringsList.innerHTML = '<p class="text-muted">モニタリング記録はまだ作成されていません</p>';
                } else {
                    // 最新10件のみ表示
                    const displayMonitorings = monitorings.slice(0, 10);

                    monitoringsList.innerHTML = `
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead class="table-light">
                                    <tr>
                                        <th>実施日</th>
                                        <th>担当者</th>
                                        <th>形態</th>
                                        <th>作成日</th>
                                        <th>操作</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${displayMonitorings.map(monitoring => `
                                        <tr>
                                            <td>${new Date(monitoring.monitoring_date).toLocaleDateString('ja-JP')}</td>
                                            <td>スタッフID: ${monitoring.staff_id}</td>
                                            <td>${monitoring.monitoring_type || '-'}</td>
                                            <td>${new Date(monitoring.created_at).toLocaleDateString('ja-JP')}</td>
                                            <td>
                                                <a href="/monitorings/${monitoring.id}" class="btn btn-sm btn-outline-primary">
                                                    <i class="bi bi-eye"></i> 詳細
                                                </a>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    `;

                    // 件数が10件を超える場合は「もっと見る」メッセージを追加
                    if (monitorings.length > 10) {
                        monitoringsList.innerHTML += `
                            <div class="alert alert-info mt-3">
                                <i class="bi bi-info-circle"></i> 最新10件を表示しています。全${monitorings.length}件の記録があります。
                            </div>
                        `;
                    }
                }
            } else {
                monitoringsList.innerHTML = '<p class="text-danger">モニタリングの取得に失敗しました</p>';
            }
        } catch (error) {
            console.error('エラー:', error);
            document.getElementById('monitorings-list').innerHTML = '<p class="text-danger">モニタリングの取得中にエラーが発生しました</p>';
        }
    }

    function addPlan() {
        window.location.href = `/plans/new?user_id=${userId}`;
    }

    function addMonitoring() {
        window.location.href = `/monitorings/new?user_id=${userId}`;
    }

    function addMedication() {
        showMedicationModal(userId);
    }

    function editMedication(medicationId) {
        showMedicationModal(userId, medicationId);
    }

    async function deleteMedication(medicationId, medicationName) {
        if (!confirm(`「${medicationName}」を削除してもよろしいですか？`)) {
            return;
        }

        try {
            const response = await fetch(`/api/medications/${medicationId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });

            if (response.ok) {
                alert('服薬情報を削除しました');
                await loadMedications(); // リロード
            } else {
                alert('削除に失敗しました');
            }
        } catch (error) {
            console.error('エラー:', error);
            alert('削除中にエラーが発生しました');
        }
    }

    function manageDoctors() {
        // 処方医管理ページへ遷移
        window.location.href = '/doctors';
    }

    async function downloadMedicationsPDF() {
        try {
            const response = await fetch(`/api/pdf/medications/user/${userId}`, {
                headers: {
                    'Authorization': `Bearer ${localStorage.getItem('access_token')}`
                }
            });

            if (response.ok) {
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `medications_user_${userId}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } else if (response.status === 401) {
                alert('認証エラー: 再度ログインしてください');
                window.location.href = '/login';
            } else {
                throw new Error('服薬情報PDFの生成に失敗しました');
            }
        } catch (error) {
            console.error('PDF出力エラー:', error);
            alert('服薬情報PDFの出力に失敗しました: ' + error.message);
        }
    }

    function deleteCurrentUser() {
        if (userData) {
            confirmDelete('users', userId, userData.name, '/users');
        }
    }

    async function downloadPDF() {
        try {
            const response = await fetch(`/api/users/${userId}/pdf`);
            if (response.ok) {
                // PDFをBlobとして取得
                const blob = await response.blob();

                // Content-Dispositionヘッダーからファイル名を取得
                const contentDisposition = response.headers.get('Content-Disposition');
                let filename = `利用者情報_${userId}.pdf`;

                if (contentDisposition) {
                    const filenameMatch = contentDisposition.match(/filename\*=UTF-8''(.+)/);
                    if (filenameMatch) {
                        filename = decodeURIComponent(filenameMatch[1]);
                    }
                }

                // ダウンロードリンクを作成
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();

                // クリーンアップ
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            } else {
                alert('PDF出力に失敗しました');
            }
        } catch (error) {
            console.error('エラー:', error);
            alert('PDF出力中にエラーが発生しました');
        }
    }

    async function loadNetworkPreview() {
        try {
            const response = await fetch(`/api/network/users/${userId}/network`);
            if (!response.ok) {
                throw new Error('ネットワークデータの取得に失敗しました');
            }

            const networkData = await response.json();
            const container = document.getElementById('network-preview');

            // コンテナをクリア
            container.innerHTML = '';

            // ネットワーク図の要約を表示
            const nodes = networkData.nodes || [];
            const edges = networkData.edges || [];

            if (nodes.length <= 1) {
                container.innerHTML = '<p class="text-muted text-center py-3">関係機関が登録されていません</p>';
                return;
            }

            // 簡易的なサマリー表示
            let html = '<div class="row g-3">';

            // 統計情報
            html += '<div class="col-12">';
            html += '<div class="alert alert-info mb-3">';
            html += `<strong><i class="bi bi-info-circle"></i> ネットワーク概要:</strong> `;
            html += `利用者を中心に ${nodes.length - 1} 件の関係機関・人物が登録されています。`;
            html += '</div>';
            html += '</div>';

            // 関係者リスト
            html += '<div class="col-12">';
            html += '<h6 class="mb-3">関係機関・関係者一覧</h6>';
            html += '<div class="row g-2">';

            for (const node of nodes) {
                if (node.type === 'user') continue; // 利用者自身はスキップ

                let iconClass = 'bi-building';
                let bgClass = 'bg-secondary';

                if (node.type === 'service') {
                    iconClass = 'bi-heart-pulse';
                    bgClass = 'bg-primary';
                } else if (node.type === 'medical') {
                    iconClass = 'bi-hospital';
                    bgClass = 'bg-danger';
                } else if (node.type === 'guardian') {
                    iconClass = 'bi-shield-check';
                    bgClass = 'bg-warning';
                } else if (node.type === 'staff') {
                    iconClass = 'bi-person-badge';
                    bgClass = 'bg-success';
                }

                html += '<div class="col-md-6 col-lg-4">';
                html += '<div class="card border-0 shadow-sm h-100">';
                html += '<div class="card-body p-3">';
                html += `<div class="d-flex align-items-center">`;
                html += `<div class="flex-shrink-0 ${bgClass} text-white rounded p-2 me-3">`;
                html += `<i class="bi ${iconClass}"></i>`;
                html += `</div>`;
                html += `<div class="flex-grow-1">`;
                html += `<h6 class="mb-0">${node.label}</h6>`;
                if (node.data) {
                    if (node.data.relationship_type) {
                        html += `<small class="text-muted">${node.data.relationship_type}</small>`;
                    }
                    if (node.data.frequency) {
                        html += `<br><small class="badge bg-light text-dark">${node.data.frequency}</small>`;
                    }
                }
                html += `</div>`;
                html += `</div>`;
                html += '</div>';
                html += '</div>';
                html += '</div>';
            }

            html += '</div>'; // row g-2
            html += '</div>'; // col-12
            html += '</div>'; // row g-3

            container.innerHTML = html;
        } catch (error) {
            console.error('エラー:', error);
            const container = document.getElementById('network-preview');
            container.innerHTML = '<p class="text-danger text-center py-3">ネットワーク図の読み込みに失敗しました</p>';
        }
    }
</script>
{% endblock %}
