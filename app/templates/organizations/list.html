{% extends "base.html" %}

{% block title %}関係機関一覧 - 計画相談支援システム{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="bi bi-building"></i> 関係機関一覧</h1>
            <a href="/organizations/new" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> 新規登録
            </a>
        </div>
    </div>
</div>

<!-- 検索エリア -->
<div class="row mb-3">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h6 class="mb-0"><i class="bi bi-search"></i> 検索条件</h6>
            </div>
            <div class="card-body">
                <form id="search-form" onsubmit="handleSearch(event)">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="search" class="form-label small">機関名・住所・電話番号で検索</label>
                            <div class="input-group">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                                <input type="text" class="form-control" id="search" name="search" placeholder="例: 北九州、ワークセンター" autocomplete="off">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label for="type" class="form-label small">種別</label>
                            <select class="form-select" id="type" name="type">
                                <option value="">すべて</option>
                                <option value="サービス事業所">サービス事業所</option>
                                <option value="医療機関">医療機関</option>
                                <option value="後見人">後見人</option>
                                <option value="その他">その他</option>
                            </select>
                        </div>
                        <div class="col-md-3 d-flex align-items-end">
                            <button class="btn btn-primary me-2" type="submit">
                                <i class="bi bi-search"></i> 検索
                            </button>
                            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                <i class="bi bi-x-circle"></i> クリア
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 関係機関一覧テーブル -->
<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th style="width: 60px;">ID</th>
                        <th>機関名</th>
                        <th>種別</th>
                        <th>電話番号</th>
                        <th>担当者</th>
                        <th>住所</th>
                        <th style="width: 100px;">操作</th>
                    </tr>
                </thead>
                <tbody id="organizations-table-body">
                    <tr>
                        <td colspan="7" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">読み込み中...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ページネーション -->
        <div id="pagination" class="mt-3"></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
let currentPage = 0;
const itemsPerPage = 20;
let currentFilters = {};

window.addEventListener('DOMContentLoaded', async () => {
    await checkAuth();
    await loadOrganizations();
});

/**
 * 検索フォーム送信処理
 */
function handleSearch(event) {
    event.preventDefault();
    const formData = new FormData(document.getElementById('search-form'));

    currentFilters = {};
    for (const [key, value] of formData.entries()) {
        if (value) {
            currentFilters[key] = value;
        }
    }

    currentPage = 0;
    loadOrganizations();
}

/**
 * 検索条件をクリア
 */
function clearSearch() {
    document.getElementById('search-form').reset();
    currentFilters = {};
    currentPage = 0;
    loadOrganizations();
}

/**
 * 関係機関一覧を読み込み
 */
async function loadOrganizations() {
    try {
        const params = new URLSearchParams({
            skip: currentPage * itemsPerPage,
            limit: itemsPerPage,
            ...currentFilters
        });

        const response = await fetch(`/api/organizations?${params}`);
        if (response.ok) {
            const organizations = await response.json();
            displayOrganizations(organizations);
            updatePagination(organizations.length);
        } else {
            alert('関係機関データの取得に失敗しました');
        }
    } catch (error) {
        console.error('エラー:', error);
        alert('サーバーとの通信に失敗しました');
    }
}

/**
 * 関係機関一覧を表示
 */
function displayOrganizations(organizations) {
    const tbody = document.getElementById('organizations-table-body');

    if (organizations.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="7" class="text-center text-muted">
                    検索条件に一致する関係機関が見つかりませんでした
                </td>
            </tr>
        `;
        return;
    }

    tbody.innerHTML = organizations.map(org => `
        <tr>
            <td>${org.id}</td>
            <td>
                <a href="/organizations/${org.id}" class="text-decoration-none">
                    <strong>${org.name}</strong>
                </a>
            </td>
            <td>
                <span class="badge ${getTypeBadgeClass(org.type)}">${org.type}</span>
            </td>
            <td>${org.phone || '-'}</td>
            <td>${org.contact_person || '-'}</td>
            <td class="small text-muted">${org.address || '-'}</td>
            <td>
                <a href="/organizations/${org.id}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-eye"></i> 詳細
                </a>
            </td>
        </tr>
    `).join('');
}

/**
 * 種別に応じたバッジクラスを取得
 */
function getTypeBadgeClass(type) {
    const typeMap = {
        'サービス事業所': 'bg-info',
        '医療機関': 'bg-success',
        '後見人': 'bg-warning',
        'その他': 'bg-secondary'
    };
    return typeMap[type] || 'bg-secondary';
}

/**
 * ページネーションを更新
 */
function updatePagination(itemCount) {
    const pagination = document.getElementById('pagination');
    const hasPrev = currentPage > 0;
    const hasNext = itemCount === itemsPerPage;

    let html = '<ul class="pagination justify-content-center mb-0">';

    // 前へボタン
    if (hasPrev) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                    <i class="bi bi-chevron-left"></i> 前へ
                </a>
            </li>
        `;
    } else {
        html += `
            <li class="page-item disabled">
                <span class="page-link">
                    <i class="bi bi-chevron-left"></i> 前へ
                </span>
            </li>
        `;
    }

    // ページ番号
    html += `
        <li class="page-item active">
            <span class="page-link">${currentPage + 1}</span>
        </li>
    `;

    // 次へボタン
    if (hasNext) {
        html += `
            <li class="page-item">
                <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                    次へ <i class="bi bi-chevron-right"></i>
                </a>
            </li>
        `;
    } else {
        html += `
            <li class="page-item disabled">
                <span class="page-link">
                    次へ <i class="bi bi-chevron-right"></i>
                </span>
            </li>
        `;
    }

    html += '</ul>';
    pagination.innerHTML = html;
}

/**
 * ページ変更
 */
function changePage(page) {
    currentPage = page;
    loadOrganizations();
    window.scrollTo(0, 0);
}
</script>
{% endblock %}
