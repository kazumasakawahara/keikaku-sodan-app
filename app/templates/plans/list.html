{% extends "base.html" %}

{% block title %}計画一覧 - 計画相談支援システム{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center">
            <h1><i class="bi bi-file-earmark-text"></i> サービス利用計画一覧</h1>
            <a href="/plans/new" class="btn btn-success">
                <i class="bi bi-plus-circle"></i> 新規作成
            </a>
        </div>
    </div>
</div>

<!-- 計画一覧テーブル -->
<div class="card shadow-sm">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>計画ID</th>
                        <th>利用者名</th>
                        <th>計画期間</th>
                        <th>承認状況</th>
                        <th>担当スタッフ</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="plans-table-body">
                    <tr>
                        <td colspan="6" class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">読み込み中...</span>
                            </div>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- ページネーション -->
        <div id="pagination" class="mt-3"></div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    window.addEventListener('DOMContentLoaded', async () => {
        await checkAuth();
        await loadPlans();
    });

    async function loadPlans() {
        try {
            const response = await fetch('/api/plans?limit=50');
            if (response.ok) {
                const plans = await response.json();
                await displayPlans(plans);
            } else {
                alert('計画データの取得に失敗しました');
            }
        } catch (error) {
            console.error('エラー:', error);
            alert('サーバーとの通信に失敗しました');
        }
    }

    async function displayPlans(plans) {
        const tbody = document.getElementById('plans-table-body');

        if (plans.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center text-muted">
                        計画がまだ登録されていません
                    </td>
                </tr>
            `;
            return;
        }

        // 利用者情報とスタッフ情報を並行取得
        const userIds = [...new Set(plans.map(p => p.user_id))];
        const staffIds = [...new Set(plans.map(p => p.staff_id))];

        const usersMap = {};
        const staffMap = {};

        await Promise.all([
            ...userIds.map(async id => {
                try {
                    const res = await fetch(`/api/users/${id}`);
                    if (res.ok) usersMap[id] = await res.json();
                } catch (e) {
                    console.error('利用者情報の取得に失敗:', id, e);
                }
            }),
            ...staffIds.map(async id => {
                try {
                    const res = await fetch(`/api/staffs/${id}`);
                    if (res.ok) staffMap[id] = await res.json();
                } catch (e) {
                    console.error('スタッフ情報の取得に失敗:', id, e);
                }
            })
        ]);

        tbody.innerHTML = plans.map(plan => {
            const user = usersMap[plan.user_id];
            const staff = staffMap[plan.staff_id];
            const userName = user ? user.name : `利用者ID: ${plan.user_id}`;
            const staffName = staff ? staff.name : `スタッフID: ${plan.staff_id}`;

            // 承認状況に応じたバッジの色
            let badgeClass = 'bg-secondary';
            if (plan.approval_status === '承認済み') badgeClass = 'bg-success';
            else if (plan.approval_status === '実施中') badgeClass = 'bg-primary';
            else if (plan.approval_status === '作成中') badgeClass = 'bg-warning';
            else if (plan.approval_status === '終了') badgeClass = 'bg-secondary';

            return `
                <tr>
                    <td>${plan.plan_number || plan.id}</td>
                    <td>
                        <a href="/users/${plan.user_id}" class="text-decoration-none">
                            ${userName}
                        </a>
                    </td>
                    <td>
                        ${new Date(plan.start_date).toLocaleDateString('ja-JP')} 〜
                        ${new Date(plan.end_date).toLocaleDateString('ja-JP')}
                    </td>
                    <td>
                        <span class="badge ${badgeClass}">
                            ${plan.approval_status || '作成中'}
                        </span>
                    </td>
                    <td>${staffName}</td>
                    <td>
                        <a href="/plans/${plan.id}" class="btn btn-sm btn-outline-primary">
                            <i class="bi bi-eye"></i> 詳細
                        </a>
                    </td>
                </tr>
            `;
        }).join('');
    }
</script>
{% endblock %}
